<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLG Paper White Calculator</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #f4f4f4;
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #ddd;
            --container-bg: #fff;
            --button-text-color: #fff;
            --tooltip-bg: #555;
            --tooltip-text-color: #fff;
            --error-color: #d9534f;
            --warning-color: #f0ad4e;
            --input-error-border: #d9534f;
            --input-warning-border: #ef634a;
            --results-bg: #e6ffed;
            --results-border: #c3e6cb;
            --results-strong-color: #155724;
            --table-header-bg: #f9f9f9;
            --table-cell-highlight-color: var(--primary-color);
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background: var(--container-bg);
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        h2 {
            color: var(--text-color);
            text-align: left;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.95em;
            color: #444;
        }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        input[type="number"].input-error, input[type="text"].input-error {
            border-color: var(--input-error-border) !important;
            box-shadow: 0 0 0 0.2rem rgba(217, 83, 79, 0.25);
        }
        input[type="number"].input-warning, input[type="text"].input-warning {
            border-color: var(--input-warning-border) !important;
            box-shadow: 0 0 0 0.2rem rgba(239, 99, 74, 0.25);
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        .radio-group input[type="radio"] {
            margin-right: 5px;
            vertical-align: middle;
        }
        .radio-group label {
            font-weight: normal;
            font-size: 0.95em;
            vertical-align: middle;
            display: inline;
        }
        .results {
            margin-top: 25px;
            border-radius: 8px;
            overflow: hidden;
        }
        .results h2 {
            margin-top: 0;
            border-bottom: none;
            text-align: center;
            font-size: 1.4em;
            color: var(--results-strong-color);
            padding: 15px;
            background-color: var(--results-bg);
            border-bottom: 1px solid var(--results-border);
        }
        .results-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--container-bg);
        }
        .results-table th, .results-table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        .results-table th {
            background-color: var(--table-header-bg);
            font-weight: 500;
            color: #555;
            width: 60%;
        }
        .results-table td {
            font-weight: 600;
            color: var(--text-color);
            font-feature-settings: "tnum";
        }
        .results-table tr:last-child th,
        .results-table tr:last-child td {
            border-bottom: none;
        }
        .results-table .highlight-value {
            font-size: 1.2em;
            color: var(--table-cell-highlight-color);
            font-weight: bold;
        }
        .hidden {
            display: none !important;
        }
        .info {
            font-size: 0.85em;
            color: var(--light-text-color);
            margin-top: 5px;
            margin-bottom: 15px;
        }
        .page-info {
            font-size: 1em;
            color: var(--light-text-color);
            margin-bottom: 20px;
            text-align: center;
        }
        .footer {
            text-align: center;
            margin-top: 35px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85em;
            color: #777;
        }
        .footer a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        .message-area {
            margin-top: 15px;
        }
        .message {
            font-weight: 500;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 6px;
            text-align: left;
        }
        .message.error {
            color: var(--button-text-color);
            background-color: var(--error-color);
        }
         .message.warning {
            color: var(--text-color);
            background-color: var(--warning-color);
            border: 1px solid #eea236;
        }
        .tab-container {
            overflow: hidden;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        .tab-button {
            background-color: #e7e7e7;
            color: #555;
            float: left;
            border: 1px solid var(--border-color);
            border-bottom: none;
            outline: none;
            cursor: pointer;
            padding: 12px 18px;
            transition: 0.3s;
            font-size: 1em;
            font-weight: 500;
            margin-right: 3px;
            border-radius: 8px 8px 0 0;
        }
        .tab-button:hover {
            background-color: #d8d8d8;
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: var(--button-text-color);
            border-color: var(--primary-color);
            font-weight: bold;
        }
        .tab-content {
            padding: 10px 5px;
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            cursor: help;
            vertical-align: middle;
        }
        .tooltip-icon {
            font-size: 0.8em;
            border: 1px solid #999;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #444;
            background-color: #e8e8e8;
            font-weight: bold;
        }
        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text-color);
            text-align: left;
            font-weight: normal;
            font-size: 0.9em;
            line-height: 1.4;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 130%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.2s ease-in-out, visibility 0s linear 0.2s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: pre-line;
        }
        .tooltip-text.show {
            visibility: visible;
            opacity: 1;
            transition: opacity 0.2s ease-in-out;
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: var(--tooltip-bg) transparent transparent transparent;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            margin-bottom: 3px;
            display: inline-block;
        }
        .input-field-container {
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HLG Paper White Calculator</h1>
        <p class="page-info">Calculate HLG diffuse white (paper white) and extended range (109%) luminance based on display peak brightness and viewing environment.</p>

        <div class="tab-container">
            <button class="tab-button active" onclick="openTab(event, 'basicSettings')">Basic Settings</button>
            <button class="tab-button" onclick="openTab(event, 'advancedSettings')">Advanced Settings</button>
        </div>

        <div id="basicSettings" class="tab-content">
            <h2>1. Viewing Environment</h2>
            <div class="radio-group">
                <span>
                    <input type="radio" id="envLux" name="envType" value="lux" checked>
                    <label for="envLux">Room Lux & Reflectivity</label>
                </span>
                <span>
                    <input type="radio" id="envNits" name="envType" value="nits">
                    <label for="envNits">Ambient Nits Directly</label>
                </span>
            </div>

            <div id="luxInputs" class="input-group">
                <div>
                    <label for="roomLux">Room Illuminance (Lux)</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Typical Values (ITU-R BT.2408-7 Table 5):
- Office (Sunny Day): 130 Lux
- Office (Cloudy Day): 75 Lux
- Edit Suite: 50 Lux
- Grading Suite: 25 Lux
- Prod. Gallery/Dark Grading: 3 Lux
(Perpendicular to the monitor surface)
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="roomLux" value="25">
                </div>
            </div>
            <div id="luxReflectivityInput" class="input-group">
                 <div>
                    <label for="reflectivity">Surround Reflectivity (0.0 to 1.0)</label>
                     <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Common Reflectivity Estimates:
- Fresh Matte White Wall: ~0.8 to 0.9
- Light Grey / Off-White Wall: ~0.6 to 0.7
- ITU-R BT.2408-7 Table 5 assumes ~0.6 for "light-coloured walls".
- 18% Grey Card: 0.18
- Darker surfaces have lower values.
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="reflectivity" step="0.01" min="0" max="1" value="0.6">
                </div>
            </div>

            <div id="nitsInput" class="hidden input-group">
                <div>
                    <label for="ambientNits">Ambient Surround Luminance (cd/m² or nits)</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Typical Values (ITU-R BT.2408-7 Table 5):
- Office (Sunny Day): 25 cd/m²
- Office (Cloudy Day): 15 cd/m²
- Edit Suite: 10 cd/m²
- Grading Suite: 5 cd/m²
- Prod. Gallery/Dark Grading: 0.5 cd/m²
(Perpendicular to the monitor surface)
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                     <input type="number" id="ambientNits" value="5">
                </div>
            </div>

            <h2>2. Display</h2>
            <div class="input-group">
                <div>
                    <label for="peakNits">Display Peak Luminance (L<sub>W</sub> for 100% HLG Signal, cd/m²)</label>
                     <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Enter the luminance your display produces for a 100% HLG signal. This is the L<sub>W</sub> used for gamma calculations.
For EBU R 167 "ext" modes (e.g., "1000ext"), this would be the nominal L<sub>W</sub> (e.g., 1000), not the extended peak.

Sources for Peak Luminance
- Physical Measurement Device
- Reviews/Tests
- Windows HDR Calibration Tool
- Display EDID / CTA-861 HDR Metadata
- Manufacturer Specs (Website/Box)
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="peakNits" value="1000">
                </div>
            </div>
        </div>

        <div id="advancedSettings" class="tab-content hidden">
            <h2>Advanced Settings</h2>
            <div class="input-group">
                 <div>
                    <label for="hlgSignalLevel">HLG Signal Level for Paper White (%)</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">The HLG signal level representing diffuse white.
ITU-R BT.2408-7 recommends 75%.
Adjusting this changes the target brightness for diffuse white.
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="hlgSignalLevel" min="1" max="100" value="75">
                     <p class="info">Default and ITU recommendation is 75%.</p>
                </div>
            </div>

            <div id="blackLevelInputGroup" class="input-group">
                <div>
                    <label for="blackLevelNits">Black Level Luminance (L<sub>B</sub>, cd/m²)</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">The measured or specified black level of your display.
Common examples:
- Dolby Cinema P3 PQ: 0.0001 cd/m²
- High-end OLED: ~0.0005 to 0.001 cd/m²
- Good LCD with FALD: ~0.005 to 0.02 cd/m²
- Typical LCD: ~0.05 to 0.1 cd/m²
ITU-R BT.2100 suggests using PLUGE (BT.814) to determine L<sub>B</sub>.
Setting to 0 effectively disables black level lift.
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="blackLevelNits" step="0.0001" min="0" value="0.0001">
                    <p class="info">Enter display's minimum black luminance. Default 0.0001 (Dolby Cinema). 0 to disable.</p>
                </div>
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <div>
                    <input type="checkbox" id="approximateQDOLEDBlack" style="vertical-align: middle; margin-right: 5px;">
                    <label for="approximateQDOLEDBlack" style="display: inline; font-weight: normal;">Approximate QD-OLED Ambient Black Level (Experimental)</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">When checked, this approximates the ambient black level for some QD-OLED displays using the formula:
Room Lux * ((rejection per 1000 Lux) / 1000)

Reasoning:
(2.2 nits black floor ) / (1000 lux of room illuminance) for QD-OLED.
minus 0.2 nits / 1000 lux for other displays, to compensate for bias,
as I don't think ambient black level raise has been used in the ITU formulas.
This will override and disable the manual L<sub>B</sub> input.
I do not know if this adjustment will result in more accurate results.
This option is only active when "Room Lux & Reflectivity" is selected for viewing environment.
                        </span>
                    </span>
                </div>
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <div>
                    <input type="checkbox" id="forceExtendedGamma" style="vertical-align: middle; margin-right: 5px;">
                    <label for="forceExtendedGamma" style="display: inline; font-weight: normal;">Force Extended Gamma Formula Always</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">ITU-R BT.2100-3 Note 5f specifies a piecewise function for System Gamma based on Display Peak Luminance: one formula for the 400-2000 cd/m² range and an 'extended' formula for values outside this range.
Enabling this option forces the continuous 'extended' formula (γ = 1.2 * κ^(log2(Lw/1000))) to be used across all peak luminance values. This will deviate from the strict ITU standard for the 400-2000 cd/m² range but provides a smoother, continuous curve.
                        </span>
                    </span>
                </div>
                <img id="extendedGammaComparisonImage" src="extended_gamma_formula_comparison.png" alt="Gamma Formula Comparison Plot" style="display: none; max-width: 100%; margin-top: 10px; border-radius: 4px; border: 1px solid var(--border-color);">
            </div>

            <div class="input-group" style="margin-top: 15px;">
                <div>
                    <input type="checkbox" id="showExtendedRangeLuminance" style="vertical-align: middle; margin-right: 5px;">
                    <label for="showExtendedRangeLuminance" style="display: inline; font-weight: normal;">Show Calculated 109% HLG Signal Luminance</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Calculates and displays the luminance produced by a 109% HLG signal level, based on the current L<sub>W</sub> (for 100% signal) and system gamma.
This utilizes the "super-white" headroom defined in EBU R 103.
The 109% signal is (1019-64)/(940-64) for 10-bit narrow range.
                        </span>
                    </span>
                </div>
            </div>
        </div>

        <div id="messageArea" class="message-area"></div>

        <div class="results hidden" id="resultsSection">
            <h2>Results</h2>
            <table class="results-table">
                <tbody>
                    <tr>
                        <th>Using HLG Paper White Signal</th>
                        <td id="resultHLGSignalUsed"></td>
                    </tr>
                    <tr>
                        <th>Calculated Ambient Surround Luminance (L<sub>amb</sub>)</th>
                        <td id="resultLAmb"></td>
                    </tr>
                    <tr id="blackLevelLiftResultRow">
                        <th>Black Level Lift (β)</th>
                        <td id="resultBlackLiftValue"></td>
                    </tr>
                    <tr>
                        <th>Peak L<sub>W</sub> Adjusted Gamma (Base)</th>
                        <td id="resultDisplayBaseGamma"></td>
                    </tr>
                    <tr>
                        <th>Surround L<sub>S</sub> Gamma Offset Comp.</th>
                        <td id="resultGammaOffset"></td>
                    </tr>
                    <tr>
                        <th>Effective System Gamma</th>
                        <td id="resultEffectiveGamma"></td>
                    </tr>
                    <tr id="luminanceAt109Row" class="hidden">
                        <th>Luminance at 109% HLG Signal</th>
                        <td id="resultLuminanceAt109" class="highlight-value"></td>
                    </tr>
                    <tr>
                        <th>Recommended HLG Paper White (75% HLG)</th>
                        <td id="resultPaperWhite" class="highlight-value"></td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="footer">
            <p>Formulas based on ITU-R BT.2100, BT.2390, and BT.2408 & EBU R 167.</p>
            <p>This is a simplified tool for educational and estimation purposes. <a href="https://github.com/NikitaMGrimm/hlg-reference-white-calc/tree/main" target="_blank">View on GitHub</a></p>
        </div>
    </div>

    <script>
        const A_HLG = 0.17883277;
        const B_HLG = 1.0 - 4.0 * A_HLG;
        const C_HLG = 0.5 - A_HLG * Math.log(4 * A_HLG);
        const LW_REF_NITS_GAMMA = 1000.0;
        const GAMMA_REF_BASE_HLG = 1.2;
        const KAPPA_HLG = 1.111;
        const L_AMB_REF_NITS_GAMMA = 5.0;
        const MU_HLG = 0.98;
        const HLG_EXTENDED_RANGE_FACTOR = (1019.0 - 64.0) / (940.0 - 64.0);

        const envLuxRadio = document.getElementById('envLux');
        const envNitsRadio = document.getElementById('envNits');
        const luxInputsDiv = document.getElementById('luxInputs');
        const luxReflectivityInputDiv = document.getElementById('luxReflectivityInput');
        const nitsInputDiv = document.getElementById('nitsInput');
        const resultsSection = document.getElementById('resultsSection');
        const messageArea = document.getElementById('messageArea');
        const roomLuxInput = document.getElementById('roomLux');
        const reflectivityInput = document.getElementById('reflectivity');
        const ambientNitsInput = document.getElementById('ambientNits');
        const peakNitsInput = document.getElementById('peakNits');
        const hlgSignalLevelInput = document.getElementById('hlgSignalLevel');

        const blackLevelInputGroupDiv = document.getElementById('blackLevelInputGroup');
        const blackLevelNitsInput = document.getElementById('blackLevelNits');
        const approximateQDOLEDBlackCheckbox = document.getElementById('approximateQDOLEDBlack');
        const blackLevelLiftResultRow = document.getElementById('blackLevelLiftResultRow');
        const resultBlackLiftValue = document.getElementById('resultBlackLiftValue');
        const forceExtendedGammaCheckbox = document.getElementById('forceExtendedGamma');
        const extendedGammaComparisonImage = document.getElementById('extendedGammaComparisonImage');
        const showExtendedRangeLuminanceCheckbox = document.getElementById('showExtendedRangeLuminance');
        const luminanceAt109Row = document.getElementById('luminanceAt109Row');
        const resultLuminanceAt109Td = document.getElementById('resultLuminanceAt109');

        const resultHLGSignalUsedTd = document.getElementById('resultHLGSignalUsed');
        const resultLAmbTd = document.getElementById('resultLAmb');
        const resultGammaOffsetTd = document.getElementById('resultGammaOffset');
        const resultDisplayBaseGammaTd = document.getElementById('resultDisplayBaseGamma');
        const resultEffectiveGammaTd = document.getElementById('resultEffectiveGamma');
        const resultPaperWhiteTd = document.getElementById('resultPaperWhite');

        let previousManualBlackLevelNits = blackLevelNitsInput.value;

        const allInputs = [
            roomLuxInput, reflectivityInput, ambientNitsInput,
            peakNitsInput, hlgSignalLevelInput, blackLevelNitsInput,
            forceExtendedGammaCheckbox, showExtendedRangeLuminanceCheckbox,
            approximateQDOLEDBlackCheckbox
        ];

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add("hidden");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.remove("hidden");
            evt.currentTarget.classList.add("active");
            calculatePaperWhite();
        }

        function toggleEnvInputType() {
             if (envLuxRadio.checked) {
                luxInputsDiv.classList.remove('hidden');
                luxReflectivityInputDiv.classList.remove('hidden');
                nitsInputDiv.classList.add('hidden');
                approximateQDOLEDBlackCheckbox.disabled = false;
            } else {
                nitsInputDiv.classList.remove('hidden');
                luxInputsDiv.classList.add('hidden');
                luxReflectivityInputDiv.classList.add('hidden');
                approximateQDOLEDBlackCheckbox.disabled = true;
                if (approximateQDOLEDBlackCheckbox.checked) {
                    approximateQDOLEDBlackCheckbox.checked = false;
                    blackLevelNitsInput.disabled = false;
                    blackLevelNitsInput.value = previousManualBlackLevelNits;
                }
            }
            calculatePaperWhite();
        }
        envLuxRadio.addEventListener('change', toggleEnvInputType);
        envNitsRadio.addEventListener('change', toggleEnvInputType);

        if (forceExtendedGammaCheckbox && extendedGammaComparisonImage) {
            forceExtendedGammaCheckbox.addEventListener('change', function() {
                extendedGammaComparisonImage.style.display = this.checked ? 'block' : 'none';
            });
        }
        if (showExtendedRangeLuminanceCheckbox && luminanceAt109Row) {
            showExtendedRangeLuminanceCheckbox.addEventListener('change', function() {
                luminanceAt109Row.classList.toggle('hidden', !this.checked);
                calculatePaperWhite();
            });
        }

        if (approximateQDOLEDBlackCheckbox) {
            approximateQDOLEDBlackCheckbox.addEventListener('change', function() {
                if (this.checked) {
                    if (!blackLevelNitsInput.disabled) {
                        previousManualBlackLevelNits = blackLevelNitsInput.value;
                    }
                } else {
                    blackLevelNitsInput.disabled = false;
                    blackLevelNitsInput.value = previousManualBlackLevelNits;
                }
                calculatePaperWhite();
            });
        }


        function addMessage(text, type = 'error') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            messageDiv.textContent = text;
            messageArea.appendChild(messageDiv);
        }

        function clearMessagesAndHighlights() {
            messageArea.innerHTML = '';
            allInputs.forEach(input => {
                if (input) {
                    input.classList.remove('input-error', 'input-warning');
                }
            });
        }

        function getEsForHLGSignal(hlgSignalEPrime) {
            if (hlgSignalEPrime <= (1.0 / Math.sqrt(3.0))) {
                return (hlgSignalEPrime ** 2) / 3.0;
            } else {
                return (Math.exp((hlgSignalEPrime - C_HLG) / A_HLG) + B_HLG) / 12.0;
            }
        }

        function calculatePaperWhite() {
            clearMessagesAndHighlights();
            resultsSection.classList.add('hidden');

            if (!approximateQDOLEDBlackCheckbox.disabled && approximateQDOLEDBlackCheckbox.checked) {
                blackLevelNitsInput.disabled = true;
                const roomLuxForQDLb = parseFloat(roomLuxInput.value);
                if (!isNaN(roomLuxForQDLb) && roomLuxForQDLb >= 0) {
                    const qdOledBlack = roomLuxForQDLb * (2.2 - 0.2) / 1000.0;
                    blackLevelNitsInput.value = Math.max(0.0001, qdOledBlack).toFixed(7);
                } else {
                    blackLevelNitsInput.value = "";
                }
            } else if (!approximateQDOLEDBlackCheckbox.disabled && !approximateQDOLEDBlackCheckbox.checked) {
                 blackLevelNitsInput.disabled = false;
            }


            let lAmbNits;
            const peakNits = parseFloat(peakNitsInput.value);
            const hlgSignalPercent = parseFloat(hlgSignalLevelInput.value);
            let isValid = true;

            if (isNaN(peakNits) || peakNits <= 0) {
                addMessage("Display Peak Luminance must be a positive number.");
                peakNitsInput.classList.add('input-error');
                isValid = false;
            }
            if (isNaN(hlgSignalPercent) || hlgSignalPercent < 1 || hlgSignalPercent > 100) {
                addMessage("HLG Signal Level for Paper White must be between 1 and 100.");
                hlgSignalLevelInput.classList.add('input-error');
                isValid = false;
            }

            const hlgSignalEPrimePaperWhite = hlgSignalPercent / 100.0;

            if (envLuxRadio.checked) {
                const roomLux = parseFloat(roomLuxInput.value);
                const reflectivity = parseFloat(reflectivityInput.value);
                if (isNaN(roomLux) || roomLux < 0) {
                    addMessage("Room Lux must be a non-negative number.");
                    roomLuxInput.classList.add('input-error');
                    isValid = false;
                }
                if (isNaN(reflectivity) || reflectivity < 0 || reflectivity > 1.0) {
                    addMessage("Reflectivity must be between 0.0 and 1.0.");
                    reflectivityInput.classList.add('input-error');
                    isValid = false;
                }
                if (isValid) {
                    lAmbNits = (roomLux === 0 && reflectivity === 0) ? 0.00001 : (roomLux * reflectivity) / Math.PI;
                    if (lAmbNits <=0) lAmbNits = 0.00001;
                    resultLAmbTd.textContent = `${lAmbNits.toFixed(3)} cd/m²`;

                    if (reflectivity < 0.01 && reflectivity >= 0) {
                        addMessage("Warning: Surround Reflectivity is very low (< 0.01), potentially affecting calculations.", "warning");
                        reflectivityInput.classList.add('input-warning');
                    }
                    if (roomLux < 2 && roomLux >= 0) {
                        addMessage("Warning: Room Illuminance is very low (< 2 Lux), potentially affecting calculations.", "warning");
                        roomLuxInput.classList.add('input-warning');
                    }
                }
            } else {
                lAmbNits = parseFloat(ambientNitsInput.value);
                if (isNaN(lAmbNits) || lAmbNits <= 0) {
                     addMessage("Ambient Nits must be a positive number.");
                     ambientNitsInput.classList.add('input-error');
                     isValid = false;
                }
                if (isValid) {
                    resultLAmbTd.textContent = `${lAmbNits.toFixed(2)} cd/m² (Directly Entered)`;
                    if (lAmbNits < 0.2 && lAmbNits > 0) {
                         addMessage("Warning: Ambient Surround Luminance is very low (< 0.2 nits), potentially affecting calculations.", "warning");
                         ambientNitsInput.classList.add('input-warning');
                    }
                }
            }
            if (isValid && lAmbNits <= 0) lAmbNits = 0.00001;

            if (!isValid) {
                resultPaperWhiteTd.textContent = "Error";
                if (resultsSection.classList.contains('hidden')) resultsSection.classList.remove('hidden');
                resultDisplayBaseGammaTd.textContent = "---";
                resultGammaOffsetTd.textContent = "---";
                resultEffectiveGammaTd.textContent = "---";
                resultBlackLiftValue.textContent = "---";
                resultLuminanceAt109Td.textContent = "---";
                return;
            }

            let gammaDisplayBase;
            const forceExtended = forceExtendedGammaCheckbox.checked;

            if (!forceExtended && peakNits >= 400 && peakNits <= 2000) {
                gammaDisplayBase = GAMMA_REF_BASE_HLG + 0.42 * Math.log10(peakNits / LW_REF_NITS_GAMMA);
            } else {
                gammaDisplayBase = GAMMA_REF_BASE_HLG * Math.pow(KAPPA_HLG, Math.log2(peakNits / LW_REF_NITS_GAMMA));
            }

            const muFactor = Math.pow(MU_HLG, Math.log2(lAmbNits / L_AMB_REF_NITS_GAMMA));
            const gammaEffective = gammaDisplayBase * muFactor;

            let beta = 0;
            const lBNits = parseFloat(blackLevelNitsInput.value);

            if (isNaN(lBNits) || lBNits < 0) {
                addMessage("Black Level Luminance (L_B) must be a non-negative number.");
                blackLevelNitsInput.classList.add('input-error');
                isValid = false;
            } else if (lBNits > peakNits) {
                 addMessage("Black Level Luminance (L_B) cannot be greater than Display Peak Luminance.");
                 blackLevelNitsInput.classList.add('input-error');
                 isValid = false;
            } else {
                if (lBNits > 0 && peakNits > 0 && gammaEffective !== 0 && isFinite(gammaEffective)) {
                    beta = Math.sqrt(3 * Math.pow(lBNits / peakNits, 1 / gammaEffective));
                    if (isNaN(beta) || !isFinite(beta)) beta = 0;
                } else {
                    beta = 0;
                }
                 if (lBNits >= 0.3 && peakNits > 0) {
                    addMessage("Warning: Black Level Luminance (L_B) is quite high (>= 0.3 cd/m²). This will significantly lift blacks.", "warning");
                    blackLevelNitsInput.classList.add('input-warning');
                }
            }
            resultBlackLiftValue.textContent = beta.toFixed(6);

            if (!isValid) {
                resultPaperWhiteTd.textContent = "Error";
                resultDisplayBaseGammaTd.textContent = gammaDisplayBase.toFixed(4);
                resultGammaOffsetTd.textContent = (gammaEffective - gammaDisplayBase).toFixed(4);
                resultEffectiveGammaTd.textContent = gammaEffective.toFixed(4);
                resultLuminanceAt109Td.textContent = "Error";
                resultsSection.classList.remove('hidden');
                return;
            }

            let ePrimeForPaperWhite = hlgSignalEPrimePaperWhite;
            if (beta > 0) {
                ePrimeForPaperWhite = Math.max(0, (1 - beta) * hlgSignalEPrimePaperWhite + beta);
            }
            const EsPaperWhite = getEsForHLGSignal(ePrimeForPaperWhite);
            const paperWhiteLum = peakNits * Math.pow(EsPaperWhite, gammaEffective);

            resultHLGSignalUsedTd.textContent = `${hlgSignalPercent.toFixed(0)} %`;
            const surroundOffsetComponentDisplay = gammaEffective - gammaDisplayBase;
            resultGammaOffsetTd.textContent = surroundOffsetComponentDisplay.toFixed(4);
            resultDisplayBaseGammaTd.textContent = gammaDisplayBase.toFixed(4);
            resultEffectiveGammaTd.textContent = gammaEffective.toFixed(4);
            resultPaperWhiteTd.textContent = `${paperWhiteLum.toFixed(2)} cd/m²`;

            if (showExtendedRangeLuminanceCheckbox.checked) {
                let ePrimeFor109 = HLG_EXTENDED_RANGE_FACTOR;
                if (beta > 0) {
                    ePrimeFor109 = Math.max(0, (1 - beta) * HLG_EXTENDED_RANGE_FACTOR + beta);
                }
                const Es109 = getEsForHLGSignal(ePrimeFor109);
                const luminance109 = peakNits * Math.pow(Es109, gammaEffective);
                resultLuminanceAt109Td.textContent = `${luminance109.toFixed(2)} cd/m²`;
                luminanceAt109Row.classList.remove('hidden');
            } else {
                luminanceAt109Row.classList.add('hidden');
            }

            resultsSection.classList.remove('hidden');

            if (peakNits < 400 && !forceExtended) {
                addMessage("Warning: Display Peak Luminance is below 400 cd/m². The ITU-R BT.2100-3 Note 5f uses the 'extended' gamma formula for this range. Results are using this extended formula.", "warning");
                 if(!peakNitsInput.classList.contains('input-warning')) peakNitsInput.classList.add('input-warning');
            } else if (peakNits > 2000 && !forceExtended) {
                 addMessage("Warning: Display Peak Luminance is above 2000 cd/m². The ITU-R BT.2100-3 Note 5f uses the 'extended' gamma formula for this range. Results are using this extended formula.", "warning");
                 if(!peakNitsInput.classList.contains('input-warning')) peakNitsInput.classList.add('input-warning');
            }

            if (paperWhiteLum < 80 && isValid) {
                addMessage(`Warning: Calculated Paper White (${paperWhiteLum.toFixed(1)} cd/m²) is below the typical sRGB diffuse white of ~80 cd/m². Consider if HDR viewing is optimal.`, "warning");
                if(!peakNitsInput.classList.contains('input-warning') && !peakNitsInput.classList.contains('input-error')) peakNitsInput.classList.add('input-warning');
            }
            if (hlgSignalPercent !== 75) {
                addMessage("Warning: HLG Paper White Signal Level is not 75%. The ITU-R BT.2408-7 recommendation is 75% for diffuse white in HLG.", "warning");
                hlgSignalLevelInput.classList.add('input-warning');
            }
        }

        allInputs.forEach(input => {
            if (input) {
                input.addEventListener('input', calculatePaperWhite);
                input.addEventListener('change', calculatePaperWhite);
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            previousManualBlackLevelNits = blackLevelNitsInput.value;
            const activeTabButton = document.querySelector('.tab-button.active');
            if (activeTabButton) {
                activeTabButton.click();
            }
            toggleEnvInputType();
            if (forceExtendedGammaCheckbox && extendedGammaComparisonImage) {
                 extendedGammaComparisonImage.style.display = forceExtendedGammaCheckbox.checked ? 'block' : 'none';
            }
            if (showExtendedRangeLuminanceCheckbox && luminanceAt109Row) {
                luminanceAt109Row.classList.toggle('hidden', !showExtendedRangeLuminanceCheckbox.checked);
            }

            blackLevelLiftResultRow.classList.remove('hidden');

            const tooltipContainers = document.querySelectorAll('.tooltip-container');
            tooltipContainers.forEach(container => {
                const tooltipText = container.querySelector('.tooltip-text');
                if (!tooltipText) return;

                let clickTimerId = null;
                let isClickActive = false;
                let isMouseOver = false;

                container.addEventListener('mouseenter', () => {
                    isMouseOver = true;
                    tooltipText.classList.add('show');
                });

                container.addEventListener('mouseleave', () => {
                    isMouseOver = false;
                    if (!isClickActive) {
                        tooltipText.classList.remove('show');
                    }
                });

                container.addEventListener('click', (event) => {
                    event.stopPropagation();
                    
                    clearTimeout(clickTimerId);

                    isClickActive = true; 
                    tooltipText.classList.add('show'); 

                    clickTimerId = setTimeout(() => {
                        isClickActive = false; 
                        if (!isMouseOver) { 
                            tooltipText.classList.remove('show'); 
                        }
                        clickTimerId = null;
                    }, 2000);
                });
            });
            
            calculatePaperWhite();
        });
    </script>
</body>
</html>