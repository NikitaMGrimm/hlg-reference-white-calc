<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HLG Paper White Calculator</title>
    <style>
        :root {
            --primary-color: #4CAF50; 
            --secondary-color: #f4f4f4;
            --text-color: #333;
            --light-text-color: #666;
            --border-color: #ddd;
            --container-bg: #fff;
            --button-text-color: #fff;
            --tooltip-bg: #555;
            --tooltip-text-color: #fff;
            --error-color: #d9534f;
            --warning-color: #f0ad4e;
            --input-error-border: #d9534f;
            --input-warning-border: #ef634a;
            --results-bg: #e6ffed; 
            --results-border: #c3e6cb;
            --results-strong-color: #155724;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            background-color: var(--secondary-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }
        .container {
            width: 100%;
            max-width: 700px;
            background: var(--container-bg);
            padding: 25px 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        h1 {
            color: var(--text-color);
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.8em;
        }
        h2 {
            color: var(--text-color);
            text-align: left;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }
        label {
            display: block;
            margin-bottom: 6px;
            font-weight: 600;
            font-size: 0.95em;
            color: #444;
        }
        input[type="number"], input[type="text"] {
            width: 100%;
            padding: 12px;
            margin-bottom: 0;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        input[type="number"].input-error, input[type="text"].input-error {
            border-color: var(--input-error-border) !important;
            box-shadow: 0 0 0 0.2rem rgba(217, 83, 79, 0.25);
        }
        input[type="number"].input-warning, input[type="text"].input-warning {
            border-color: var(--input-warning-border) !important;
            box-shadow: 0 0 0 0.2rem rgba(255, 0, 0, 0.25);
        }
        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            align-items: center;
            margin-bottom: 20px;
        }
        .radio-group input[type="radio"] {
            margin-right: 5px;
            vertical-align: middle;
        }
        .radio-group label {
            font-weight: normal;
            font-size: 0.95em;
            vertical-align: middle;
            display: inline;
        }
        .results {
            margin-top: 25px;
            padding: 20px;
            background-color: var(--results-bg);
            border: 1px solid var(--results-border);
            border-radius: 8px;
        }
        .results h2 {
            margin-top: 0;
            border-bottom: none;
            text-align: center;
            font-size: 1.4em;
            color: var(--results-strong-color);
        }
        .results p {
            margin: 8px 0;
            font-size: 1em;
        }
        .results strong {
            color: var(--results-strong-color);
            font-weight: 600;
        }
        .hidden {
            display: none !important;
        }
        .info {
            font-size: 0.85em;
            color: var(--light-text-color);
            margin-top: 5px;
            margin-bottom: 15px; 
        }
        .page-info { 
            font-size: 1em;
            color: var(--light-text-color);
            margin-bottom: 20px;
            text-align: center;
        }
        .footer {
            text-align: center;
            margin-top: 35px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85em;
            color: #777;
        }
        .footer a {
            color: var(--primary-color);
            text-decoration: none;
        }
        .footer a:hover {
            text-decoration: underline;
        }
        .message-area {
            margin-top: 15px;
        }
        .message {
            font-weight: 500;
            margin-bottom: 10px;
            padding: 10px 15px;
            border-radius: 6px;
            text-align: left;
        }
        .message.error {
            color: var(--button-text-color);
            background-color: var(--error-color);
        }
         .message.warning {
            color: var(--text-color);
            background-color: var(--warning-color);
            border: 1px solid #eea236;
        }
        .tab-container {
            overflow: hidden;
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
        }
        .tab-button {
            background-color: #e7e7e7; 
            color: #555; 
            float: left;
            border: 1px solid var(--border-color);
            border-bottom: none;
            outline: none;
            cursor: pointer;
            padding: 12px 18px;
            transition: 0.3s;
            font-size: 1em;
            font-weight: 500;
            margin-right: 3px;
            border-radius: 8px 8px 0 0;
        }
        .tab-button:hover {
            background-color: #d8d8d8;
        }
        .tab-button.active {
            background-color: var(--primary-color);
            color: var(--button-text-color); 
            border-color: var(--primary-color);
            font-weight: bold;
        }
        .tab-content {
            padding: 10px 5px;
        }
        .tooltip-container {
            position: relative;
            display: inline-block;
            margin-left: 8px;
            cursor: help;
            vertical-align: middle;
        }
        .tooltip-icon {
            font-size: 0.8em;
            border: 1px solid #999;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            color: #444;
            background-color: #e8e8e8;
            font-weight: bold;
        }
        .tooltip-text {
            visibility: hidden;
            width: 280px;
            background-color: var(--tooltip-bg);
            color: var(--tooltip-text-color);
            text-align: left;
            font-weight: normal;
            font-size: 0.9em;
            line-height: 1.4;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 10;
            bottom: 130%; 
            left: 50%;
            margin-left: -140px; 
            opacity: 0;
            transition: opacity 0.2s ease-in-out;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            white-space: pre-line; 
        }
        .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -6px;
            border-width: 6px;
            border-style: solid;
            border-color: var(--tooltip-bg) transparent transparent transparent;
        }
        .tooltip-container:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        .input-group {
            margin-bottom: 20px;
        }
        .input-group label {
            margin-bottom: 3px; 
            display: inline-block; 
        }
        .input-field-container { 
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>HLG Paper White Calculator</h1>
        <p class="page-info">Calculate the recommended HLG diffuse white (paper white) luminance based on your display's peak brightness and viewing environment.</p>

        <div class="tab-container">
            <button class="tab-button active" onclick="openTab(event, 'basicSettings')">Basic Settings</button>
            <button class="tab-button" onclick="openTab(event, 'advancedSettings')">Advanced Settings</button>
        </div>

        <div id="basicSettings" class="tab-content">
            <h2>1. Viewing Environment</h2>
            <div class="radio-group">
                <span>
                    <input type="radio" id="envLux" name="envType" value="lux" checked>
                    <label for="envLux">Room Lux & Reflectivity</label>
                </span>
                <span>
                    <input type="radio" id="envNits" name="envType" value="nits">
                    <label for="envNits">Ambient Nits Directly</label>
                </span>
            </div>

            <div id="luxInputs" class="input-group">
                <div>
                    <label for="roomLux">Room Illuminance (Lux)</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Typical Values (ITU-R BT.2408-7 Table 5):
- Office (Sunny Day): 130 Lux
- Office (Cloudy Day): 75 Lux
- Edit Suite: 50 Lux
- Grading Suite: 25 Lux
- Prod. Gallery/Dark Grading: 3 Lux
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="roomLux" value="25">
                </div>
            </div>
            <div id="luxReflectivityInput" class="input-group">
                 <div>
                    <label for="reflectivity">Surround Reflectivity (0.0 to 1.0)</label>
                     <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Common Reflectivity Estimates:
- Fresh Matte White Wall: ~0.8 to 0.9
- Light Grey / Off-White Wall: ~0.6 to 0.7
- ITU-R BT.2408-7 Table 5 assumes ~0.6 for "light-coloured walls".
- 18% Grey Card: 0.18
- Darker surfaces have lower values.
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="reflectivity" step="0.01" min="0" max="1" value="0.6">
                </div>
            </div>

            <div id="nitsInput" class="hidden input-group">
                <div>
                    <label for="ambientNits">Ambient Surround Luminance (cd/m² or nits)</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Typical Values (ITU-R BT.2408-7 Table 5):
- Office (Sunny Day): 25 cd/m²
- Office (Cloudy Day): 15 cd/m²
- Edit Suite: 10 cd/m²
- Grading Suite: 5 cd/m²
- Prod. Gallery/Dark Grading: 0.5 cd/m²
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                     <input type="number" id="ambientNits" value="5">
                </div>
            </div>

            <h2>2. Display</h2>
            <div class="input-group">
                <div>
                    <label for="peakNits">Display Peak Luminance (cd/m² or nits)</label>
                     <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">Sources for Peak Luminance:
- Physical Measurement (Colorimeter/Spectro)
- Windows HDR Calibration Tool
- Display EDID / CTA-861 HDR Metadata
- Manufacturer Specs (Website/Box)
- Eye Estimation (less accurate)
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="peakNits" value="1000">
                </div>
            </div>
        </div>

        <div id="advancedSettings" class="tab-content hidden">
            <h2>Advanced Settings</h2>
            <div class="input-group">
                 <div>
                    <label for="hlgSignalLevel">HLG Signal Level for Paper White (%)</label>
                    <span class="tooltip-container">
                        <span class="tooltip-icon">?</span>
                        <span class="tooltip-text">The HLG signal level representing diffuse white.
ITU-R BT.2408-7 recommends 75%.
Adjusting this changes the target brightness for diffuse white.
                        </span>
                    </span>
                </div>
                <div class="input-field-container">
                    <input type="number" id="hlgSignalLevel" min="1" max="100" value="75">
                     <p class="info">Default and ITU recommendation is 75%.</p>
                </div>
            </div>
        </div>

        <div id="messageArea" class="message-area"></div>

        <div class="results hidden" id="resultsSection">
            <h2>Results</h2>
            <p>Using HLG Paper White Signal: <strong id="resultHLGSignalUsed"></strong> %</p>
            <p>Calculated Ambient Surround Luminance (L_amb): <strong id="resultLAmb"></strong> cd/m²</p>
            <p>Environmental Gamma Offset: <strong id="resultGammaOffset"></strong></p>
            <p>Display Base Gamma (for Peak Nits): <strong id="resultDisplayBaseGamma"></strong></p>
            <p>Effective System Gamma: <strong id="resultEffectiveGamma"></strong></p>
            <p style="font-size: 1.2em;">Recommended HLG Paper White: <strong id="resultPaperWhite" style="font-size: 1.3em;"></strong> <strong>cd/m²</strong></p>
        </div>

        <div class="footer">
            <p>Formulas based on ITU-R BT.2100, BT.2390, and BT.2408.</p>
            <p>This is a simplified tool for educational and estimation purposes. <a href="https://github.com/NikitaMGrimm/hlg-reference-white-calc/tree/main" target="_blank">View on GitHub</a></p>
        </div>
    </div>

    <script>
        const A_HLG = 0.17883277;
        const B_HLG = 1.0 - 4.0 * A_HLG; 
        const C_HLG = 0.5 - A_HLG * Math.log(4 * A_HLG);
        const LW_REF_NITS_GAMMA = 1000.0; 
        const GAMMA_REF_BASE_HLG = 1.2;
        const L_AMB_REF_NITS_GAMMA = 5.0; 
        const envLuxRadio = document.getElementById('envLux');
        const envNitsRadio = document.getElementById('envNits');
        const luxInputsDiv = document.getElementById('luxInputs');
        const luxReflectivityInputDiv = document.getElementById('luxReflectivityInput');
        const nitsInputDiv = document.getElementById('nitsInput');
        const resultsSection = document.getElementById('resultsSection');
        const messageArea = document.getElementById('messageArea');
        const roomLuxInput = document.getElementById('roomLux');
        const reflectivityInput = document.getElementById('reflectivity');
        const ambientNitsInput = document.getElementById('ambientNits');
        const peakNitsInput = document.getElementById('peakNits');
        const hlgSignalLevelInput = document.getElementById('hlgSignalLevel');
        const allInputs = [roomLuxInput, reflectivityInput, ambientNitsInput, peakNitsInput, hlgSignalLevelInput];

        function openTab(evt, tabName) {
            let i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add("hidden");
            }
            tablinks = document.getElementsByClassName("tab-button");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.remove("hidden");
            evt.currentTarget.classList.add("active");
            calculatePaperWhite();
        }

        function toggleEnvInputType() {
             if (envLuxRadio.checked) {
                luxInputsDiv.classList.remove('hidden');
                luxReflectivityInputDiv.classList.remove('hidden');
                nitsInputDiv.classList.add('hidden');
            } else {
                nitsInputDiv.classList.remove('hidden');
                luxInputsDiv.classList.add('hidden');
                luxReflectivityInputDiv.classList.add('hidden');
            }
            calculatePaperWhite(); 
        }
        envLuxRadio.addEventListener('change', toggleEnvInputType);
        envNitsRadio.addEventListener('change', toggleEnvInputType);
        
        function addMessage(text, type = 'error') {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('message', type);
            messageDiv.textContent = text;
            messageArea.appendChild(messageDiv);
        }

        function clearMessagesAndHighlights() {
            messageArea.innerHTML = '';
            allInputs.forEach(input => {
                input.classList.remove('input-error', 'input-warning');
            });
        }

        function getEsForHLGSignal(hlgSignalEPrime) {
            if (hlgSignalEPrime <= (1.0 / Math.sqrt(3.0))) {
                return (hlgSignalEPrime ** 2) / 3.0;
            } else {
                return (Math.exp((hlgSignalEPrime - C_HLG) / A_HLG) + B_HLG) / 12.0;
            }
        }

        function calculatePaperWhite() {
            clearMessagesAndHighlights();
            resultsSection.classList.add('hidden'); 

            let lAmbNits;
            const peakNits = parseFloat(peakNitsInput.value);
            const hlgSignalPercent = parseFloat(hlgSignalLevelInput.value);
            let isValid = true;

            if (isNaN(peakNits) || peakNits <= 0) {
                addMessage("Display Peak Luminance must be a positive number.");
                peakNitsInput.classList.add('input-error');
                isValid = false;
            }
            if (isNaN(hlgSignalPercent) || hlgSignalPercent < 1 || hlgSignalPercent > 100) {
                addMessage("HLG Signal Level for Paper White must be between 1 and 100.");
                hlgSignalLevelInput.classList.add('input-error');
                isValid = false;
            }
            
            const hlgSignalEPrime = hlgSignalPercent / 100.0;

            if (envLuxRadio.checked) {
                const roomLux = parseFloat(roomLuxInput.value);
                const reflectivity = parseFloat(reflectivityInput.value);
                if (isNaN(roomLux) || roomLux < 0) {
                    addMessage("Room Lux must be a non-negative number.");
                    roomLuxInput.classList.add('input-error');
                    isValid = false;
                }
                if (isNaN(reflectivity) || reflectivity < 0 || reflectivity > 1.0) {
                    addMessage("Reflectivity must be between 0.0 and 1.0.");
                    reflectivityInput.classList.add('input-error');
                    isValid = false;
                }
                if (isValid) {
                    lAmbNits = (roomLux === 0 && reflectivity === 0) ? 0.00001 : (roomLux * reflectivity) / Math.PI;
                    if (lAmbNits <=0) lAmbNits = 0.00001;
                    document.getElementById('resultLAmb').textContent = lAmbNits.toFixed(3);

                    if (reflectivity < 0.01 && reflectivity >= 0) { 
                        addMessage("Warning: Surround Reflectivity is very low (< 0.01), potentially affecting results negatively.", "warning");
                        reflectivityInput.classList.add('input-warning');
                    }
                    if (roomLux < 2 && roomLux >= 0) {
                        addMessage("Warning: Room Illuminance is very low (< 2 Lux), potentially affecting results negatively.", "warning");
                        roomLuxInput.classList.add('input-warning');
                    }
                }
            } else {
                lAmbNits = parseFloat(ambientNitsInput.value);
                if (isNaN(lAmbNits) || lAmbNits <= 0) {
                     addMessage("Ambient Nits must be a positive number.");
                     ambientNitsInput.classList.add('input-error');
                     isValid = false;
                }
                if (isValid) {
                    document.getElementById('resultLAmb').textContent = `N/A (Directly Entered: ${lAmbNits.toFixed(2)})`;
                    if (lAmbNits < 0.2 && lAmbNits > 0) { 
                         addMessage("Warning: Ambient Surround Luminance is very low (< 0.2 nits), potentially affecting results negatively.", "warning");
                         ambientNitsInput.classList.add('input-warning');
                    }
                }
            }
            if (isValid && lAmbNits <= 0) lAmbNits = 0.00001; 

            if (!isValid) return;

            const ES_PAPER_WHITE_DYNAMIC = getEsForHLGSignal(hlgSignalEPrime);
            const gammaOffsetEnv = -0.076 * Math.log10(lAmbNits / L_AMB_REF_NITS_GAMMA);
            const gammaDisplayBase = GAMMA_REF_BASE_HLG + 0.42 * Math.log10(peakNits / LW_REF_NITS_GAMMA);
            const gammaEffective = gammaDisplayBase + gammaOffsetEnv;
            const paperWhiteLum = peakNits * Math.pow(ES_PAPER_WHITE_DYNAMIC, gammaEffective);

            document.getElementById('resultHLGSignalUsed').textContent = hlgSignalPercent.toFixed(0);
            document.getElementById('resultGammaOffset').textContent = gammaOffsetEnv.toFixed(4);
            document.getElementById('resultDisplayBaseGamma').textContent = gammaDisplayBase.toFixed(4);
            document.getElementById('resultEffectiveGamma').textContent = gammaEffective.toFixed(4);
            document.getElementById('resultPaperWhite').textContent = paperWhiteLum.toFixed(2);

            resultsSection.classList.remove('hidden');

            if (peakNits < 400) {
                addMessage("Warning: Display Peak Luminance is below 400 cd/m². True HDR often requires higher peak brightness (e.g., VESA DisplayHDR 400 is a minimum certification).", "warning");
                peakNitsInput.classList.add('input-warning');
            }
            if (paperWhiteLum < 80) {
                addMessage(`Warning: Calculated Paper White (${paperWhiteLum.toFixed(1)} cd/m²) is below the typical sRGB diffuse white of ~80 cd/m². HDR not recommended.`, "warning");
                if(!peakNitsInput.classList.contains('input-warning')) peakNitsInput.classList.add('input-warning');
            }
            if (hlgSignalPercent !== 75) {
                addMessage("Warning: HLG Paper White Signal Level is not 75%. The ITU-R BT.2408-7 recommendation is 75% for diffuse white in HLG.", "warning");
                hlgSignalLevelInput.classList.add('input-warning');
            }
        }

        allInputs.forEach(input => {
            input.addEventListener('input', calculatePaperWhite);
            input.addEventListener('change', calculatePaperWhite);
        });
        
        document.addEventListener('DOMContentLoaded', () => {
            toggleEnvInputType(); 
            calculatePaperWhite(); 
        });
    </script>
</body>
</html>
